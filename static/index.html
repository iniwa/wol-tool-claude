<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WoL Control Panel</title>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f14;
    --surface: #151820;
    --surface2: #1c2030;
    --border: #2a3045;
    --accent: #00e5ff;
    --accent2: #ff6b35;
    --green: #39ff14;
    --red: #ff2d55;
    --text: #c8d4e8;
    --muted: #5a6a8a;
    --mono: 'Share Tech Mono', monospace;
    --sans: 'Barlow', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    background-image:
      repeating-linear-gradient(0deg, transparent, transparent 39px, var(--border) 39px, var(--border) 40px),
      repeating-linear-gradient(90deg, transparent, transparent 39px, var(--border) 39px, var(--border) 40px);
    background-size: 40px 40px;
    background-attachment: fixed;
    opacity: 1;
  }

  header {
    background: var(--surface);
    border-bottom: 2px solid var(--accent);
    padding: 0 2rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    height: 64px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 0 30px rgba(0,229,255,0.08);
  }

  .logo-mark {
    width: 36px;
    height: 36px;
    border: 2px solid var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--mono);
    font-size: 14px;
    color: var(--accent);
    transform: rotate(45deg);
    flex-shrink: 0;
  }
  .logo-mark span { transform: rotate(-45deg); display: block; }

  h1 {
    font-family: var(--mono);
    font-size: 1.1rem;
    color: var(--accent);
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  .header-sub {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    margin-left: auto;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  /* --- Add Device Form --- */
  .add-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: 3px solid var(--accent2);
    padding: 1.5rem;
    margin-bottom: 2rem;
    position: relative;
  }

  .section-label {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--accent2);
    letter-spacing: 0.3em;
    text-transform: uppercase;
    margin-bottom: 1.2rem;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 0.75rem;
    align-items: end;
  }

  @media (max-width: 700px) {
    .form-grid { grid-template-columns: 1fr; }
  }

  .field label {
    display: block;
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.2em;
    text-transform: uppercase;
    margin-bottom: 0.4rem;
  }

  input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.6rem 0.8rem;
    font-family: var(--mono);
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.2s;
  }
  input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent) inset, 0 0 8px rgba(0,229,255,0.1);
  }
  input::placeholder { color: var(--muted); }

  .btn {
    padding: 0.6rem 1.4rem;
    font-family: var(--mono);
    font-size: 0.8rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .btn-add {
    background: var(--accent2);
    color: #fff;
  }
  .btn-add:hover { filter: brightness(1.15); transform: translateY(-1px); }
  .btn-add:active { transform: translateY(0); }

  /* --- Device List --- */
  .list-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .list-controls {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .device-grid {
    display: grid;
    gap: 0.75rem;
  }

  .device-card {
    background: var(--surface);
    border: 1px solid var(--border);
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .device-card:hover {
    border-color: var(--accent);
    box-shadow: 0 0 20px rgba(0,229,255,0.05);
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    position: relative;
  }
  .status-dot.online {
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
  }
  .status-dot.online::after {
    content: '';
    position: absolute;
    inset: -4px;
    border-radius: 50%;
    background: var(--green);
    opacity: 0.2;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.2; }
    50% { transform: scale(1.8); opacity: 0; }
  }
  .status-dot.offline {
    background: var(--muted);
    box-shadow: none;
  }
  .status-dot.unknown {
    background: var(--muted);
    opacity: 0.4;
  }

  .device-info .name {
    font-weight: 700;
    font-size: 1rem;
    color: #e8f0ff;
    margin-bottom: 0.25rem;
  }
  .device-info .meta {
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--muted);
  }
  .device-info .meta .mac { color: var(--accent); margin-right: 1rem; }

  .device-actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn-wake {
    background: transparent;
    color: var(--accent);
    border: 1px solid var(--accent);
    padding: 0.45rem 1rem;
    font-size: 0.75rem;
  }
  .btn-wake:hover {
    background: var(--accent);
    color: var(--bg);
  }
  .btn-wake.sending {
    animation: blink 0.4s step-end infinite;
    pointer-events: none;
  }
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .btn-delete {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 0.45rem 0.7rem;
    font-size: 0.75rem;
  }
  .btn-delete:hover {
    color: var(--red);
    border-color: var(--red);
  }

  /* --- Toast --- */
  #toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--surface2);
    border-left: 3px solid var(--accent);
    padding: 0.8rem 1.2rem;
    font-family: var(--mono);
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.25s;
    pointer-events: none;
    z-index: 999;
    max-width: 300px;
  }
  #toast.show {
    opacity: 1;
    transform: translateY(0);
  }
  #toast.error { border-left-color: var(--red); }
  #toast.success { border-left-color: var(--green); }

  /* --- Empty state --- */
  .empty {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--muted);
    font-family: var(--mono);
    font-size: 0.85rem;
    letter-spacing: 0.1em;
    border: 1px dashed var(--border);
  }

  .last-seen {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
  }

  @media (max-width: 600px) {
    .device-card { grid-template-columns: auto 1fr; }
    .device-actions { grid-column: 1 / -1; }
    .last-seen { display: none; }
  }

  /* --- Edit mode --- */
  .device-card.editing {
    grid-template-columns: auto 1fr auto;
  }

  .edit-form {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 0.75rem;
  }

  @media (max-width: 700px) {
    .edit-form { grid-template-columns: 1fr; }
  }

  .btn-edit {
    background: transparent;
    color: var(--accent2);
    border: 1px solid var(--accent2);
    padding: 0.45rem 0.7rem;
    font-size: 0.75rem;
  }
  .btn-edit:hover { background: var(--accent2); color: #fff; }

  .btn-save {
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 0.45rem 1rem;
    font-size: 0.75rem;
  }
  .btn-save:hover { filter: brightness(1.1); }

  .btn-cancel {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 0.45rem 0.7rem;
    font-size: 0.75rem;
  }
  .btn-cancel:hover { color: var(--red); border-color: var(--red); }

  /* --- Ping controls --- */
  .btn-ping-all {
    background: transparent;
    color: var(--green);
    border: 1px solid var(--green);
    padding: 0.45rem 0.9rem;
    font-size: 0.75rem;
  }
  .btn-ping-all:hover { background: var(--green); color: var(--bg); }
  .btn-ping-all.sending { animation: blink 0.4s step-end infinite; pointer-events: none; }

  .interval-control {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--muted);
  }
  .interval-control input {
    width: 55px;
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
    text-align: center;
  }
  .btn-interval-set {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    letter-spacing: 0.05em;
  }
  .btn-interval-set:hover { color: var(--accent); border-color: var(--accent); }

  .last-seen.clickable { cursor: pointer; transition: color 0.15s; }
  .last-seen.clickable:hover { color: var(--accent); }
  .last-seen.pinging { animation: blink 0.4s step-end infinite; color: var(--accent); pointer-events: none; }
</style>
</head>
<body>

<header>
  <div class="logo-mark"><span>WL</span></div>
  <h1>Wake-on-LAN</h1>
  <div class="header-sub" id="clock">--:--:--</div>
</header>

<div class="container">

  <div class="add-section">
    <div class="section-label">// 新しいデバイスを追加</div>
    <div class="form-grid">
      <div class="field">
        <label>デバイス名</label>
        <input type="text" id="inp-name" placeholder="My PC" />
      </div>
      <div class="field">
        <label>MACアドレス</label>
        <input type="text" id="inp-mac" placeholder="AA:BB:CC:DD:EE:FF" />
      </div>
      <div class="field">
        <label>IPアドレス（ping用・任意）</label>
        <input type="text" id="inp-ip" placeholder="192.168.1.100" />
      </div>
      <div class="field">
        <button class="btn btn-add" onclick="addDevice()">+ 追加</button>
      </div>
    </div>
  </div>

  <div class="list-header">
    <div class="section-label" style="margin:0">// デバイス一覧</div>
    <div class="list-controls">
      <button class="btn btn-ping-all" onclick="pingAll()">◎ 全台確認</button>
      <div class="interval-control">
        <span>自動:</span>
        <input type="number" id="interval-input" min="0" max="3600"
               onkeydown="if(event.key==='Enter')savePingInterval()">
        <span>秒</span>
        <button class="btn btn-interval-set" onclick="savePingInterval()">設定</button>
      </div>
    </div>
  </div>

  <div class="device-grid" id="device-list">
    <div class="empty">デバイスが登録されていません</div>
  </div>

</div>

<div id="toast"></div>

<script>
const API = '';
let devices = [];
let pingInterval = 30;
let autoReloadTimer = null;

function toast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + type;
  clearTimeout(el._t);
  el._t = setTimeout(() => el.className = '', 2800);
}

function statusDot(device) {
  if (!device.ip) return `<div class="status-dot unknown" title="監視なし"></div>`;
  if (device.online) return `<div class="status-dot online" title="オンライン"></div>`;
  return `<div class="status-dot offline" title="オフライン"></div>`;
}

function statusBadge(d) {
  if (!d.ip) return `<div class="last-seen">—</div>`;
  const label = d.online ? 'ONLINE' : 'OFFLINE';
  return `<div class="last-seen clickable" onclick="pingDevice('${d.id}')" title="クリックしてPING確認">${label}</div>`;
}

function render(list) {
  const el = document.getElementById('device-list');
  if (!list.length) {
    el.innerHTML = '<div class="empty">デバイスが登録されていません</div>';
    return;
  }
  el.innerHTML = list.map(d => `
    <div class="device-card" id="card-${d.id}">
      ${statusDot(d)}
      <div class="device-info">
        <div class="name">${esc(d.name)}</div>
        <div class="meta">
          <span class="mac">${esc(d.mac)}</span>
          ${d.ip ? `<span>${esc(d.ip)}</span>` : ''}
          ${d.last_seen ? ` · 最終確認: ${d.last_seen}` : ''}
        </div>
      </div>
      ${statusBadge(d)}
      <div class="device-actions">
        <button class="btn btn-wake" id="wake-${d.id}" onclick="wake('${d.id}', '${esc(d.name)}')">▷ WAKE</button>
        <button class="btn btn-edit" onclick="editDevice('${d.id}')">✎ 編集</button>
        <button class="btn btn-delete" onclick="deleteDevice('${d.id}', '${esc(d.name)}')">✕</button>
      </div>
    </div>
  `).join('');
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function load() {
  try {
    const r = await fetch(`${API}/api/devices`);
    devices = await r.json();
    render(devices);
  } catch(e) {
    toast('サーバーに接続できません', 'error');
  }
}

async function loadConfig() {
  try {
    const r = await fetch(`${API}/api/config`);
    const cfg = await r.json();
    pingInterval = cfg.ping_interval;
    document.getElementById('interval-input').value = pingInterval;
  } catch(e) {
    document.getElementById('interval-input').value = pingInterval;
  } finally {
    startAutoReload();
  }
}

function startAutoReload() {
  if (autoReloadTimer) clearInterval(autoReloadTimer);
  autoReloadTimer = null;
  if (pingInterval > 0) {
    autoReloadTimer = setInterval(load, pingInterval * 1000);
  }
}

async function savePingInterval() {
  const val = parseInt(document.getElementById('interval-input').value, 10);
  if (isNaN(val) || val < 0) { toast('有効な値（0以上）を入力してください', 'error'); return; }
  const r = await fetch(`${API}/api/config`, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ping_interval: val})
  });
  if (r.ok) {
    pingInterval = val;
    startAutoReload();
    toast(val === 0 ? '自動確認を無効化しました' : `自動確認: ${val}秒に設定しました`, 'success');
  } else {
    toast('設定に失敗しました', 'error');
  }
}

async function pingAll() {
  const btn = document.querySelector('.btn-ping-all');
  btn.classList.add('sending');
  btn.textContent = '◎ 確認中...';
  try {
    const r = await fetch(`${API}/api/ping/all`, {method: 'POST'});
    if (r.ok) {
      devices = await r.json();
      render(devices);
      toast('全デバイスの生存確認が完了しました', 'success');
    } else {
      toast('確認に失敗しました', 'error');
    }
  } catch {
    toast('接続エラー', 'error');
  } finally {
    btn.classList.remove('sending');
    btn.textContent = '◎ 全台確認';
  }
}

async function pingDevice(id) {
  const card = document.getElementById(`card-${id}`);
  const badge = card ? card.querySelector('.last-seen') : null;
  if (badge) badge.classList.add('pinging');
  try {
    const r = await fetch(`${API}/api/devices/${id}/ping`, {method: 'POST'});
    if (r.ok) {
      const updated = await r.json();
      const idx = devices.findIndex(d => d.id === id);
      if (idx !== -1) devices[idx] = updated;
      render(devices);
    } else {
      const e = await r.json();
      toast(e.error || 'PING失敗', 'error');
      if (badge) badge.classList.remove('pinging');
    }
  } catch {
    toast('接続エラー', 'error');
    if (badge) badge.classList.remove('pinging');
  }
}

async function addDevice() {
  const name = document.getElementById('inp-name').value.trim();
  const mac  = document.getElementById('inp-mac').value.trim();
  const ip   = document.getElementById('inp-ip').value.trim();
  if (!name || !mac) { toast('名前とMACアドレスは必須です', 'error'); return; }

  const r = await fetch(`${API}/api/devices`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({name, mac, ip})
  });
  if (!r.ok) {
    const e = await r.json();
    toast(e.error || '追加に失敗しました', 'error');
    return;
  }
  document.getElementById('inp-name').value = '';
  document.getElementById('inp-mac').value = '';
  document.getElementById('inp-ip').value = '';
  toast(`${name} を追加しました`, 'success');
  load();
}

async function wake(id, name) {
  const btn = document.getElementById(`wake-${id}`);
  btn.classList.add('sending');
  btn.textContent = 'SENDING...';
  try {
    const r = await fetch(`${API}/api/devices/${id}/wake`, {method:'POST'});
    if (r.ok) {
      toast(`✓ ${name} にマジックパケットを送信しました`, 'success');
    } else {
      const e = await r.json();
      toast(e.error || '送信失敗', 'error');
    }
  } catch {
    toast('送信エラー', 'error');
  } finally {
    btn.classList.remove('sending');
    btn.textContent = '▷ WAKE';
  }
}

function editDevice(id) {
  const d = devices.find(x => x.id === id);
  if (!d) return;
  const card = document.getElementById(`card-${id}`);
  card.classList.add('editing');
  card.innerHTML = `
    ${statusDot(d)}
    <div class="edit-form">
      <div class="field">
        <label>デバイス名</label>
        <input type="text" id="edit-name-${id}" value="${esc(d.name)}">
      </div>
      <div class="field">
        <label>MACアドレス</label>
        <input type="text" id="edit-mac-${id}" value="${esc(d.mac)}">
      </div>
      <div class="field">
        <label>IPアドレス（任意）</label>
        <input type="text" id="edit-ip-${id}" value="${esc(d.ip || '')}">
      </div>
    </div>
    <div class="device-actions">
      <button class="btn btn-save" onclick="saveDevice('${id}')">✓ 保存</button>
      <button class="btn btn-cancel" onclick="load()">キャンセル</button>
    </div>
  `;
  document.getElementById(`edit-name-${id}`).focus();
}

async function saveDevice(id) {
  const name = document.getElementById(`edit-name-${id}`).value.trim();
  const mac  = document.getElementById(`edit-mac-${id}`).value.trim();
  const ip   = document.getElementById(`edit-ip-${id}`).value.trim();
  if (!name || !mac) { toast('名前とMACアドレスは必須です', 'error'); return; }
  const r = await fetch(`${API}/api/devices/${id}`, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name, mac, ip})
  });
  if (r.ok) {
    toast(`${name} を更新しました`, 'success');
    load();
  } else {
    const e = await r.json();
    toast(e.error || '更新に失敗しました', 'error');
  }
}

async function deleteDevice(id, name) {
  if (!confirm(`"${name}" を削除しますか？`)) return;
  const r = await fetch(`${API}/api/devices/${id}`, {method:'DELETE'});
  if (r.status === 204) {
    toast(`${name} を削除しました`);
    load();
  } else {
    toast('削除に失敗しました', 'error');
  }
}

// 時計
setInterval(() => {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('ja-JP');
}, 1000);

// 初期化
load();
loadConfig();
</script>
</body>
</html>
